<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HPR Quick Coach</title>
<style>
  :root{
    --bg:#f6f8fc; --card:#ffffff; --text:#0f172a; --muted:#64748b; --line:#e5e7eb;
    --blue:#0b3aa8; --blue2:#1e4fbf; --orange:#f97316;
    --good:#16a34a; --bad:#dc2626; --warn:#d97706;
    --shadow:0 10px 26px rgba(2,6,23,.08); --radius:14px;
    --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
  .topbar{
    display:flex;align-items:center;justify-content:space-between;gap:12px;
    padding:12px 14px;background:linear-gradient(90deg,var(--blue),var(--blue2));color:#fff;border-bottom:3px solid var(--orange)
  }
  .topbar .left{display:flex;flex-direction:column;gap:2px}
  .topbar h1{margin:0;font-size:15px;font-weight:950;letter-spacing:.2px}
  .topbar .sub{margin:0;font-size:11.5px;opacity:.92;line-height:1.25}
  .pill{display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,.16);
    border:1px solid rgba(255,255,255,.22);border-radius:999px;padding:6px 10px;font-size:12px}
  .mono{font-family:var(--mono)}
  .wrap{max-width:1150px;margin:0 auto;padding:10px 12px}
  .grid{display:grid;grid-template-columns:1fr;gap:10px}
  @media(min-width:980px){.grid{grid-template-columns:1.2fr .8fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px}
  .card h2{margin:0 0 8px 0;font-size:12px;letter-spacing:.25px;text-transform:uppercase;color:var(--muted)}
  .row{display:grid;grid-template-columns:1fr;gap:8px}
  @media(min-width:780px){.row.cols3{grid-template-columns:1fr 1fr 1fr}.row.cols4{grid-template-columns:1fr 1fr 1fr 1fr}}
  label{display:block;font-size:11px;color:var(--muted);margin-bottom:4px;font-weight:900}
  input,select{width:100%;border:1px solid var(--line);border-radius:12px;padding:9px 10px;font-size:14px;outline:none;background:#fff;color:var(--text)}
  input.ro{background:#f8fafc}
  .btn{border:1px solid var(--line);background:#fff;color:var(--text);border-radius:10px;padding:8px 10px;font-weight:950;font-size:12px;cursor:pointer}
  .btn.primary{background:var(--blue2);color:#fff;border-color:transparent}
  .btn.primary:hover{background:var(--blue)}
  .btn.small{padding:7px 9px;font-size:11px}
  .btnline{
    display:flex;flex-wrap:wrap;gap:8px
  }
  .btnline .btn{border-radius:999px}
  .btn.active{outline:3px solid rgba(249,115,22,.25);border-color:rgba(249,115,22,.45)}
  .actions{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:8px}
  .kpis{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .kpi{border:1px solid var(--line);border-radius:14px;padding:10px;background:#fff}
  .kpi .k{font-size:11px;color:var(--muted);font-weight:900}
  .kpi .v{margin-top:4px;font-size:18px;font-weight:1000}
  .status{
    border:1px solid var(--line);border-radius:14px;padding:10px;background:linear-gradient(180deg,#fff,#fbfdff);
    display:flex;justify-content:space-between;gap:10px;align-items:flex-start
  }
  .status.good{border-color:rgba(22,163,74,.35)}
  .status.bad{border-color:rgba(220,38,38,.35)}
  .status.warn{border-color:rgba(217,119,6,.35)}
  .status .title{font-size:16px;font-weight:1000;margin:0}
  .status.good .title{color:var(--good)}
  .status.bad .title{color:var(--bad)}
  .status.warn .title{color:var(--warn)}
  .status .detail{margin-top:4px;color:var(--muted);font-size:11.5px;line-height:1.25}
  .badge{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:4px 8px;font-size:11px;font-weight:1000;border:1px solid var(--line);background:#fff}
  .badge.good{border-color:rgba(22,163,74,.35);color:var(--good)}
  .badge.bad{border-color:rgba(220,38,38,.35);color:var(--bad)}
  .tiny{font-size:11px;color:var(--muted);line-height:1.25}
  details{border:1px dashed rgba(100,116,139,.35);border-radius:12px;padding:8px 10px;background:#fff}
  details summary{cursor:pointer;font-weight:900;color:var(--muted);font-size:11.5px}
  .finish{font-size:12px;margin-top:6px}
  .finish .mono{font-weight:900}
</style>
</head>
<body>
  <div class="topbar">
    <div class="left">
      <h1>HPR Quick Coach</h1>
      <div class="sub">Fast coaching view: HPR now, forecast end, finish time (if schedule &lt; capacity), and a prominent recovery plan.</div>
    </div>
    <div class="pill"><span>Now</span><span class="mono" id="nowClock">--:--</span></div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- Left: Inputs + KPIs -->
      <section class="card">
        <h2>Line + Inputs</h2>

        <div class="btnline" id="lineButtons"></div>

        <div class="row cols4" style="margin-top:10px">
          <div>
            <label>Shift</label>
            <select id="shiftSel">
              <option value="DAY">Day Shift (06:00–14:30)</option>
              <option value="PIC2">Pictures 2nd Shift (15:30–24:00)</option>
            </select>
          </div>
          <div>
            <label>Schedule (Units)</label>
            <input id="schedUnits" type="number" min="0" inputmode="numeric" />
            <div class="tiny">Capacity shown below. Use “Cap” button to auto-fill.</div>
          </div>
          <div>
            <label>Produced (Cumulative Today)</label>
            <input id="doneUnits" type="number" min="0" inputmode="numeric" />
            <div class="tiny">For Pictures, enter total schedule & produced across shifts.</div>
          </div>
          <div>
            <label>Current HPR% (auto)</label>
            <input id="hprAuto" class="ro" type="text" readonly value="—" />
          </div>
        </div>

        <div class="actions">
          <button class="btn small" id="capBtn" type="button">Cap</button>
          <button class="btn small" type="button" onclick="addUnits(10)">+10</button>
          <button class="btn small" type="button" onclick="addUnits(25)">+25</button>
          <button class="btn small" type="button" onclick="addUnits(50)">+50</button>
          <button class="btn primary" id="calcBtn" type="button">Update</button>
        </div>

        <div class="row cols3" style="margin-top:10px">
          <div class="kpi">
            <div class="k">Capacity (units)</div>
            <div class="v" id="capVal">—</div>
          </div>
          <div class="kpi">
            <div class="k">Plan-to-Now (units @100%)</div>
            <div class="v" id="planNow">—</div>
          </div>
          <div class="kpi">
            <div class="k">Forecast End (units)</div>
            <div class="v" id="fcstEnd">—</div>
          </div>
        </div>

        <div class="kpis" style="margin-top:8px">
          <div class="kpi">
            <div class="k">Delta vs Schedule</div>
            <div class="v" id="delta">—</div>
          </div>
          <div class="kpi">
            <div class="k">Finish Time if schedule &lt; capacity</div>
            <div class="v" id="finish">—</div>
          </div>
        </div>

        <div class="finish tiny" id="finishNote"></div>

        <details style="margin-top:10px">
          <summary>Break/Lunch settings (compact)</summary>
          <div class="tiny" style="margin-top:8px">
            These defaults are per your note. Edit if a line changes.
          </div>
          <div class="row cols3" style="margin-top:8px">
            <div>
              <label>Break 1</label>
              <input id="br1" class="mono" placeholder="HH:MM-HH:MM" />
            </div>
            <div>
              <label>Lunch</label>
              <input id="lunch" class="mono" placeholder="HH:MM-HH:MM" />
            </div>
            <div>
              <label>Optional Break 2</label>
              <input id="br2" class="mono" placeholder="HH:MM-HH:MM (blank ok)" />
            </div>
          </div>
          <div class="actions">
            <button class="btn small" id="saveBreaksBtn" type="button">Save Breaks</button>
            <span class="tiny">Breaks are applied to HPR/plan-to-now and forecast.</span>
          </div>
        </details>

      </section>

      <!-- Right: Prominent Recovery -->
      <aside class="card">
        <h2>Recovery Plan</h2>
        <div class="status" id="statusBox">
          <div>
            <div class="title" id="statusTitle">Waiting</div>
            <div class="detail" id="statusDetail">Enter schedule + produced, then Update.</div>
          </div>
          <div class="pill"><span>Avail Min Rem</span><span class="mono" id="availRem">—</span></div>
        </div>

        <div style="margin-top:10px" id="recoveryBox" class="tiny">
          Run Update to generate a recovery plan.
        </div>

        <div style="margin-top:12px" class="tiny">
          <b>Line defaults:</b><br/>
          Line1/Pictures break 09:00–09:15, lunch 11:45–12:15<br/>
          Casement break 08:45–09:00, lunch 11:15–11:45<br/>
          Line2/3 break 09:10–09:25, lunch 12:15–12:45
        </div>
      </aside>
    </div>
  </div>

<script>
const CAPACITY = {"LINE1":260,"LINE2":385,"LINE3":195,"CASEMENT":108,"PICTURES":115}; // Pictures per shift capacity reference

// Shift windows
const DAY = {start:"06:00", end:"14:30"};
const PIC2 = {start:"15:30", end:"24:00"}; // app uses this when shift=PIC2

// Break defaults by line per your note
const BREAK_DEFAULTS = {
  "LINE1": {br1:"09:00-09:15", lunch:"11:45-12:15", br2:""},
  "PICTURES": {br1:"09:00-09:15", lunch:"11:45-12:15", br2:""},
  "CASEMENT": {br1:"08:45-09:00", lunch:"11:15-11:45", br2:""},
  "LINE2": {br1:"09:10-09:25", lunch:"12:15-12:45", br2:""},
  "LINE3": {br1:"09:10-09:25", lunch:"12:15-12:45", br2:""},
};

const LS = {
  line:"hprqc_line_v1",
  shift:"hprqc_shift_v1",
  sched:"hprqc_sched_v1",
  breaks:"hprqc_breaks_v1"
};

const $ = (id)=>document.getElementById(id);
function pad(n){return String(n).padStart(2,"0");}
function nowMin(){const d=new Date(); return d.getHours()*60+d.getMinutes();}
function parseHHMM(hhmm){ const [h,m]=hhmm.split(":").map(Number); return h*60+m; }
function shiftTimes(shiftCode){
  const s = (shiftCode==="PIC2") ? PIC2 : DAY;
  return {start:parseHHMM(s.start), end:parseHHMM(s.end)};
}
function parseRange(r){
  if(!r) return null;
  const parts=r.split("-");
  if(parts.length!==2) return null;
  const a=parts[0].trim(), b=parts[1].trim();
  if(!/^\d{2}:\d{2}$/.test(a) || !/^\d{2}:\d{2}$/.test(b)) return null;
  return {s:parseHHMM(a), e:parseHHMM(b)};
}
function overlap(aS,aE,bS,bE){
  const s=Math.max(aS,bS), e=Math.min(aE,bE);
  return Math.max(0,e-s);
}
function getLine(){
  return localStorage.getItem(LS.line) || "LINE1";
}
function setLine(line){
  localStorage.setItem(LS.line,line);
  // update active buttons
  [...document.querySelectorAll("[data-linebtn]")].forEach(b=>{
    b.classList.toggle("active", b.getAttribute("data-linebtn")===line);
  });
  // update capacity display
  $("capVal").textContent = (line==="PICTURES") ? CAPACITY["PICTURES"]+" / shift" : CAPACITY[line];
  // apply default breaks if none saved
  loadBreaksForLine(line);
  // set default schedule = capacity (editable)
  const savedSched = JSON.parse(localStorage.getItem(LS.sched) || "{}");
  if(savedSched[line]!==undefined){
    $("schedUnits").value = savedSched[line];
  }else{
    $("schedUnits").value = (line==="PICTURES") ? CAPACITY["PICTURES"] : CAPACITY[line];
  }
  // shift default: day for all except pictures (PIC2)
  $("shiftSel").value = (line==="PICTURES") ? "PIC2" : "DAY";
}

function saveSched(line, val){
  const o = JSON.parse(localStorage.getItem(LS.sched) || "{}");
  o[line]=val;
  localStorage.setItem(LS.sched, JSON.stringify(o));
}

function loadBreaksForLine(line){
  const all = JSON.parse(localStorage.getItem(LS.breaks) || "{}");
  const b = all[line] || BREAK_DEFAULTS[line] || {br1:"",lunch:"",br2:""};
  $("br1").value = b.br1 || "";
  $("lunch").value = b.lunch || "";
  $("br2").value = b.br2 || "";
}

function saveBreaksForLine(line){
  const all = JSON.parse(localStorage.getItem(LS.breaks) || "{}");
  all[line] = {br1:$("br1").value.trim(), lunch:$("lunch").value.trim(), br2:$("br2").value.trim()};
  localStorage.setItem(LS.breaks, JSON.stringify(all));
}

function buildLineButtons(){
  const container=$("lineButtons");
  const lines=["LINE1","LINE2","LINE3","CASEMENT","PICTURES"];
  container.innerHTML="";
  lines.forEach(l=>{
    const b=document.createElement("button");
    b.className="btn";
    b.textContent = l==="PICTURES" ? "PICTURES" : l;
    b.setAttribute("data-linebtn", l);
    b.onclick=()=>{ setLine(l); update(); };
    container.appendChild(b);
  });
}

function computeAvailElapsedAndRemaining(shiftCode, breaks){
  const {start,end} = shiftTimes(shiftCode);
  let now = nowMin();
  // pictures shift can be before start; if after midnight and now<start, treat now+1440
  if(end===1440 && now < start) now += 1440;

  const endClamp = Math.min(now, end);
  const elapsedGross = Math.max(0, endClamp - start);
  const remGross = Math.max(0, end - Math.max(now, start));

  let subElapsed=0, subRem=0;
  for(const br of breaks){
    if(!br) continue;
    let s=br.s, e=br.e;
    if(end===1440 && now>1440){
      if(s<start) s+=1440;
      if(e<=s) e+=1440;
    }
    subElapsed += overlap(start, endClamp, s, e);
    subRem += overlap(Math.max(now,start), end, s, e);
  }
  const elapsedAvail = Math.max(0, elapsedGross - subElapsed);
  const remAvail = Math.max(0, remGross - subRem);
  const plannedAvail = Math.max(1, elapsedAvail + remAvail);
  return {elapsedAvail, remAvail, plannedAvail};
}

function update(){
  const line=getLine();
  const shiftCode=$("shiftSel").value;
  const sched=Number($("schedUnits").value);
  const done=Number($("doneUnits").value);

  if(!Number.isFinite(sched) || sched<=0 || !Number.isFinite(done) || done<0){
    $("hprAuto").value="—"; $("planNow").textContent="—"; $("fcstEnd").textContent="—";
    $("delta").textContent="—"; $("finish").textContent="—"; $("availRem").textContent="—";
    setStatus("warn","Enter inputs","Need schedule and produced to compute.");
    return;
  }

  // breaks for this line
  const breaks = [parseRange($("br1").value.trim()), parseRange($("lunch").value.trim()), parseRange($("br2").value.trim())].filter(Boolean);

  // For Pictures cumulative day: include day-shift elapsed+planned even when on PIC2
  let elapsedAvail, remAvail, plannedAvail;
  if(line==="PICTURES" && shiftCode==="PIC2"){
    // full day planned = day shift planned + pic2 planned (from start to end)
    // elapsed = full day elapsed = day shift planned (assume completed) + pic2 elapsed so far
    // remaining = remaining in pic2 shift only
    // Day shift breaks for Pictures per your note: use same breaks as line1 (already defaulted)
    const dayBreaks = [parseRange("09:00-09:15"), parseRange("11:45-12:15")].filter(Boolean);
    const dayCalc = computeAvailElapsedAndRemaining("DAY", dayBreaks);
    // For cumulative, count full day shift as elapsed planned (even if now is during pictures)
    const picCalc = computeAvailElapsedAndRemaining("PIC2", breaks);
    elapsedAvail = dayCalc.plannedAvail + picCalc.elapsedAvail;
    remAvail = picCalc.remAvail;
    plannedAvail = dayCalc.plannedAvail + picCalc.plannedAvail;
  }else{
    const calc = computeAvailElapsedAndRemaining(shiftCode, breaks);
    elapsedAvail = calc.elapsedAvail;
    remAvail = calc.remAvail;
    plannedAvail = calc.plannedAvail;
  }

  const planToNow = sched * (elapsedAvail / plannedAvail);
  const hpr = (planToNow>0) ? (done/planToNow) : 0;
  $("planNow").textContent = planToNow.toFixed(1);
  $("hprAuto").value = (hpr*100).toFixed(1) + "%";
  $("availRem").textContent = remAvail.toFixed(0);

  // forecast end assuming current HPR continues
  const unitsPerMin100 = sched / plannedAvail;
  const forecastAdd = unitsPerMin100 * (hpr) * remAvail;
  const fcstEnd = done + forecastAdd;
  $("fcstEnd").textContent = fcstEnd.toFixed(0);
  const delta = fcstEnd - sched;
  $("delta").textContent = (delta>=0?"+":"") + delta.toFixed(0);

  // status + recovery
  if(delta >= 0){
    setStatus("good","GREEN (On Track)",`${line}: projected to hit schedule. Protect the constraint + avoid micro-stops.`);
    $("recoveryBox").innerHTML = `
      <span class="badge good">GREEN</span> <b>Protect the day.</b><br/>
      • Keep flow: no starving / no blocking at the constraint.<br/>
      • Maintain the next-hour standard. If the next hour dips → immediate response (no-stop window).`;
  }else{
    const short = Math.abs(delta);
    const hrsLeft = remAvail/60;
    const addPerHr = (hrsLeft>0)?(short/hrsLeft):short;
    setStatus("bad","RED (Off Track)",`${line}: projected short by ${short.toFixed(0)}. Need +${addPerHr.toFixed(1)} units/hr to recover.`);
    $("recoveryBox").innerHTML = `
      <span class="badge bad">RED</span> <b>Recovery required.</b><br/>
      • Short by <b>${short.toFixed(0)}</b> units (if current pace continues).<br/>
      • Need to win back <b>${addPerHr.toFixed(1)}</b> extra units/hr for the rest of the shift.<br/>
      • Set a 60-min “no-stop window” + dedicated responder (TL/utility).<br/>
      • Kill 1 chronic loss category now (materials, minor jams, quality holds).<br/>
      • If next hour not improved → escalate (add help or containment plan).`;
  }

  // finish time if schedule < capacity (use current pace so far)
  const cap = (line==="PICTURES") ? CAPACITY["PICTURES"] : CAPACITY[line];
  const now = nowMin();
  if(sched < cap && elapsedAvail > 0){
    const pacePerMin = done / elapsedAvail; // available minutes pace
    const remainingUnits = Math.max(0, sched - done);
    const minsNeeded = (pacePerMin>0) ? (remainingUnits / pacePerMin) : Infinity;

    if(Number.isFinite(minsNeeded)){
      // estimate finish = now + minsNeeded + breaks remaining (already excluded by using available minutes pace)
      const finishMin = now + minsNeeded;
      const hrs = Math.floor(finishMin/60);
      const mins = Math.floor(finishMin%60);
      $("finish").textContent = hrs + ":" + String(mins).padStart(2,"0");
      $("finishNote").innerHTML = `Schedule is under capacity → at current pace, expected finish around <span class="mono">${hrs}:${String(mins).padStart(2,"0")}</span>.`;
    }else{
      $("finish").textContent = "—";
      $("finishNote").textContent = "";
    }
  }else{
    $("finish").textContent = "Shift End";
    $("finishNote").textContent = "";
  }

  saveSched(line, sched);
}

function setStatus(kind,title,detail){
  const box=$("statusBox");
  box.classList.remove("good","bad","warn");
  if(kind) box.classList.add(kind);
  $("statusTitle").textContent=title;
  $("statusDetail").textContent=detail;
}

function addUnits(x){
  const v = Number($("doneUnits").value || 0);
  $("doneUnits").value = String(v + x);
  update();
}

$("capBtn").addEventListener("click", ()=>{
  const line=getLine();
  $("schedUnits").value = (line==="PICTURES") ? CAPACITY["PICTURES"] : CAPACITY[line];
  update();
});
$("calcBtn").addEventListener("click", update);
$("saveBreaksBtn").addEventListener("click", ()=>{
  const line=getLine();
  saveBreaksForLine(line);
  update();
});
$("shiftSel").addEventListener("change", update);
$("schedUnits").addEventListener("input", update);
$("doneUnits").addEventListener("input", update);

function tickClock(){
  const d=new Date();
  $("nowClock").textContent = pad(d.getHours())+":"+pad(d.getMinutes());
}
setInterval(()=>{ tickClock(); }, 1000);
tickClock();

function init(){
  buildLineButtons();
  const savedLine=localStorage.getItem(LS.line);
  setLine(savedLine && CAPACITY[savedLine]!==undefined ? savedLine : "LINE1");
  update();
}
init();
</script>
</body>
</html>
