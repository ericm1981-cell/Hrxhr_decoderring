<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="light" />
  <title>HPR Hour Tracker</title>
  <style>
    /* Crisp "Time Study" style: blue/orange banner, clean white cards, high readability */
    :root{
      --bg:#f6f8fc;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --blue:#1e4fbf;
      --blue2:#0b3aa8;
      --orange:#f97316;
      --good:#16a34a;
      --bad:#dc2626;
      --warn:#d97706;
      --shadow: 0 10px 26px rgba(2, 6, 23, .08);
      --radius:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}

    .topbar{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      padding:14px 16px;background:linear-gradient(90deg,#0b3aa8,#1e4fbf);
      color:#fff;border-bottom:3px solid var(--orange)
    }
    .topbar h1{font-size:16px;margin:0;letter-spacing:.2px;font-weight:900}
    .topbar .sub{margin-top:6px;font-size:12px;opacity:.92;line-height:1.35;max-width:760px}
    .rightStack{display:flex;flex-direction:column;align-items:flex-end;gap:8px;white-space:nowrap}
    .pill{
      display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,.16);
      border:1px solid rgba(255,255,255,.22);border-radius:999px;padding:6px 10px;font-size:12px
    }
    .mono{font-family:var(--mono)}
    .btn{
      border:1px solid var(--line);background:#fff;color:var(--text);
      border-radius:10px;padding:10px 12px;font-weight:800;font-size:13px;cursor:pointer;
      box-shadow:0 2px 0 rgba(2,6,23,.03)
    }
    .btn:hover{border-color:#cbd5e1}
    .btn.primary{background:var(--blue);color:#fff;border-color:transparent}
    .btn.primary:hover{background:var(--blue2)}
    .btn.ghost{background:transparent;border-color:rgba(255,255,255,.35);color:#fff;box-shadow:none}
    .btn.ghost:hover{background:rgba(255,255,255,.10)}
    .btn.small{padding:7px 10px;font-size:12px}
    .btn.danger{background:#fff;color:var(--bad);border-color:rgba(220,38,38,.25)}
    .btn.danger:hover{border-color:rgba(220,38,38,.45)}

    .grid{margin-top:14px;display:grid;grid-template-columns:1fr;gap:14px}
    @media (min-width: 1020px){ .grid{grid-template-columns:1.18fr .82fr;} }

    .card{
      background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
      box-shadow:var(--shadow);padding:14px
    }
    .card h2{margin:0 0 10px 0;font-size:13px;letter-spacing:.25px;text-transform:uppercase;color:var(--muted)}
    .row{display:grid;gap:10px;grid-template-columns:1fr}
    @media (min-width: 720px){
      .row.cols2{grid-template-columns:1fr 1fr;}
      .row.cols3{grid-template-columns:1fr 1fr 1fr;}
      .row.cols4{grid-template-columns:1fr 1fr 1fr 1fr;}
    }
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px;font-weight:900}
    select,input,textarea{
      width:100%;border:1px solid var(--line);background:#fff;color:var(--text);
      border-radius:12px;padding:10px 10px;font-size:14px;outline:none
    }
    textarea{min-height:160px;resize:vertical;font-family:var(--mono);font-size:12px}
    input::placeholder{color:#94a3b8}
    .actions{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:flex-start;margin-top:10px}
    .divider{height:1px;background:var(--line);margin:12px 0}
    .hint{color:var(--muted);font-size:12px;line-height:1.4;margin-top:8px}

    .status{
      margin-top:12px;border:1px solid var(--line);border-radius:14px;padding:14px;
      background:linear-gradient(180deg,#ffffff,#fbfdff);
      display:flex;justify-content:space-between;gap:12px;align-items:flex-start
    }
    .status .title{font-size:18px;font-weight:1000;margin:0}
    .status .detail{margin-top:6px;color:var(--muted);font-size:12px;line-height:1.35}
    .status.good{border-color:rgba(22,163,74,.35)}
    .status.bad{border-color:rgba(220,38,38,.35)}
    .status.warn{border-color:rgba(217,119,6,.35)}
    .status.good .title{color:var(--good)}
    .status.bad .title{color:var(--bad)}
    .status.warn .title{color:var(--warn)}

    .kpis{margin-top:12px;display:grid;grid-template-columns:1fr;gap:10px}
    @media (min-width: 720px){ .kpis{grid-template-columns:1fr 1fr;} }
    .kpi{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff}
    .kpi .k{font-size:12px;color:var(--muted);font-weight:900}
    .kpi .v{margin-top:6px;font-size:20px;font-weight:1000;letter-spacing:.2px}

    table{
      width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border-radius:12px;
      border:1px solid var(--line);font-size:12px
    }
    th,td{padding:9px 10px;border-bottom:1px solid var(--line);text-align:left}
    th{
      background:#f8fafc;color:var(--muted);font-weight:1000;text-transform:uppercase;letter-spacing:.2px;font-size:11px
    }
    tr:last-child td{border-bottom:none}
    .footer{margin-top:12px;color:var(--muted);font-size:11px;line-height:1.4}
  </style>
</head>

<body>
  <div class="topbar">
    <div>
      <h1>HPR Hour Tracker</h1>
      <div class="sub">
        Live hour check against your <b>target units per hour</b>. Shows <b>On Track / Off Track</b>, unit delta,
        <b>projected end-of-hour</b>, and <b>pace needed</b>. Includes a simple <b>log</b> you can export for Tier reviews.
      </div>
    </div>
    <div class="rightStack">
      <div class="pill"><span>Now</span><span class="mono" id="nowClock">--:--</span></div>
      <div class="pill"><span>Version</span><span class="mono" id="verStamp">HPR-v1.2</span></div>
      <button class="btn ghost small" id="toggleClockBtn" type="button">Clock: ON</button>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- LEFT: Tracker -->
      <section class="card">
        <h2>Live Hour Check</h2>

        <div class="row cols4">
          <div>
            <label>Line</label>
            <select id="lineSelect"></select>
          </div>
          <div>
            <label>Hour Start</label>
            <select id="hourSelect"></select>
          </div>
          <div>
            <label>Actual Units (so far this hour)</label>
            <input id="actualInput" type="number" min="0" inputmode="numeric" placeholder="e.g., 42" />
          </div>
          <div>
            <label>Target Mode</label>
            <select id="targetMode">
              <option value="100">100% (Hit Plan)</option>
              <option value="105">105% (Recovery)</option>
              <option value="110">110% (Aggressive)</option>
            </select>
          </div>
        </div>

        <div class="actions">
          <button class="btn primary" id="calcBtn" type="button">Calculate</button>
          <button class="btn" id="useNowBtn" type="button">Set Hour to Now</button>
          <button class="btn" id="addLogBtn" type="button">Add to Log</button>
          <button class="btn danger" id="clearBtn" type="button">Clear</button>
        </div>

        <div class="status" id="statusBox">
          <div>
            <div class="title" id="statusText">Waiting for input</div>
            <div class="detail" id="statusDetail">Select line + hour, enter actual units, then Calculate.</div>
          </div>
          <div class="pill">
            <span>Target</span>
            <span class="mono" id="targetInline">—</span>
          </div>
        </div>

        <div class="kpis">
          <div class="kpi">
            <div class="k">Target Units (this hour, incl. mode)</div>
            <div class="v" id="targetOut">—</div>
          </div>
          <div class="kpi">
            <div class="k">Delta (Actual − Target)</div>
            <div class="v" id="deltaOut">—</div>
          </div>
          <div class="kpi">
            <div class="k">HPR % (Actual ÷ Base Target)</div>
            <div class="v" id="hprOut">—</div>
          </div>
          <div class="kpi">
            <div class="k">Units Needed to Hit Target Mode</div>
            <div class="v" id="neededOut">—</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="hint">
          If the selected hour is the <b>current hour</b>, this computes projected end-of-hour and the pace needed.
        </div>

        <div class="kpis">
          <div class="kpi">
            <div class="k">Minutes Remaining (current hour only)</div>
            <div class="v" id="minsRemainOut">—</div>
          </div>
          <div class="kpi">
            <div class="k">Required Units / Minute (to hit mode target)</div>
            <div class="v" id="rateOut">—</div>
          </div>
          <div class="kpi">
            <div class="k">Projected End-of-Hour Units (at current pace)</div>
            <div class="v" id="projOut">—</div>
          </div>
          <div class="kpi">
            <div class="k">Projected End Delta vs Mode Target</div>
            <div class="v" id="projDeltaOut">—</div>
          </div>
        </div>

        <div class="footer">
          Coach standard: after any miss, don’t explain first. Declare <b>units lost</b> and the <b>recovery plan</b>.
          Use Target Mode = 105% for recovery hours.
        </div>
      </section>

      <!-- RIGHT: Targets + Log -->
      <aside class="card">
        <h2>Targets Setup</h2>

        <div class="row cols2">
          <div>
            <label>Import Targets CSV</label>
            <input id="csvFile" type="file" accept=".csv,text/csv" />
            <div class="hint">
              CSV header: <span class="mono">line,hour,target</span><br/>
              Example: <span class="mono">LINE2,09:00,48</span><br/>
              Hours use <span class="mono">HH:MM</span> 24-hour (supports <span class="mono">15:30</span> for Pictures 2nd shift).
            </div>
            <div class="actions">
              <button class="btn primary" id="importCsvBtn" type="button">Import CSV</button>
            </div>
          </div>

          <div>
            <label>Quick Controls</label>
            <div class="actions">
              <button class="btn primary" id="saveTargetsBtn" type="button">Save Targets</button>
              <button class="btn" id="resetTargetsBtn" type="button">Reset to Sample</button>
            </div>
            <div class="hint">Targets + log are saved locally on this device/browser.</div>
          </div>
        </div>

        <div class="divider"></div>

        <label>Targets JSON (editable)</label>
        <textarea id="targetsJson"></textarea>

        <div class="divider"></div>

        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <div style="font-weight:1000; font-size:13px; color:var(--muted); text-transform:uppercase; letter-spacing:.25px;">
            Selected Line Targets
          </div>
          <div class="pill"><span class="mono" id="lineBadge">—</span></div>
        </div>

        <div style="margin-top:10px;">
          <table>
            <thead><tr><th>Hour</th><th>Target</th></tr></thead>
            <tbody id="targetsTableBody"></tbody>
          </table>
        </div>

        <div class="divider"></div>

        <h2 style="margin-top:0;">Hour Log</h2>
        <div class="actions">
          <button class="btn primary" id="exportLogCsvBtn" type="button">Export Log CSV</button>
          <button class="btn" id="exportLogJsonBtn" type="button">Export Log JSON</button>
          <button class="btn danger" id="clearLogBtn" type="button">Clear Log</button>
        </div>

        <div class="hint" style="margin-top:8px;">
          Log rows are created with “Add to Log” after a calculation. Use this for Tier reviews (miss stacking, recovery behavior).
        </div>

        <div style="margin-top:10px;">
          <table>
            <thead>
              <tr>
                <th>Date</th><th>Time</th><th>Line</th><th>Hour</th><th>Actual</th><th>Target</th><th>Mode</th><th>Delta</th>
              </tr>
            </thead>
            <tbody id="logTableBody"></tbody>
          </table>
        </div>

        <div class="footer">
          If you want auto-log every hour (no button), say so and I’ll add it with a confirmation toggle.
        </div>
      </aside>
    </div>
  </div>

<script>
/* HPR Hour Tracker — single-file GitHub Pages app (index.html)
   Features:
   - Targets import CSV (line,hour,target) and editable JSON
   - Target modes: 100%, 105%, 110% (multiplies base target)
   - On/off track, delta, HPR%, needed units
   - Current-hour pace + projection
   - Simple log with export CSV/JSON
*/

const LS_KEY_TARGETS = "hpr_targets_v1";
const LS_KEY_LOG     = "hpr_hour_log_v1";

const SAMPLE_TARGETS = {
  "LINE1": {"06:00":40,"07:00":40,"08:00":40,"09:00":40,"10:00":40,"11:00":40,"12:00":40,"13:00":40,"14:00":40},
  "LINE2": {"06:00":48,"07:00":48,"08:00":48,"09:00":48,"10:00":48,"11:00":48,"12:00":48,"13:00":48,"14:00":48},
  "LINE3": {"06:00":42,"07:00":42,"08:00":42,"09:00":42,"10:00":42,"11:00":42,"12:00":42,"13:00":42,"14:00":42},
  "CASEMENT": {"06:00":18,"07:00":18,"08:00":18,"09:00":18,"10:00":18,"11:00":18,"12:00":18,"13:00":18,"14:00":18},
  "PICTURES": {
    "06:00":30,"07:00":30,"08:00":30,"09:00":30,"10:00":30,"11:00":30,"12:00":30,"13:00":30,"14:00":30,
    "15:30":28,"16:30":28,"17:30":28,"18:30":28,"19:30":28,"20:30":28,"21:30":28,"22:30":28,"23:30":28
  }
};

let targets = loadJSON(LS_KEY_TARGETS, SAMPLE_TARGETS);
let hourLog = loadJSON(LS_KEY_LOG, []); // array of {date,time,line,hour,actual,targetBase,targetModePct,targetModeTarget,delta}

let clockOn = true;
let clockTimer = null;
let lastCalcSnapshot = null;

const $ = (id)=>document.getElementById(id);

const lineSelect = $("lineSelect");
const hourSelect = $("hourSelect");
const actualInput = $("actualInput");
const targetMode = $("targetMode");

const statusBox = $("statusBox");
const statusText = $("statusText");
const statusDetail = $("statusDetail");
const targetInline = $("targetInline");

const targetOut = $("targetOut");
const deltaOut = $("deltaOut");
const hprOut = $("hprOut");
const neededOut = $("neededOut");
const minsRemainOut = $("minsRemainOut");
const rateOut = $("rateOut");
const projOut = $("projOut");
const projDeltaOut = $("projDeltaOut");

const nowClock = $("nowClock");
const toggleClockBtn = $("toggleClockBtn");

const targetsJson = $("targetsJson");
const targetsTableBody = $("targetsTableBody");
const logTableBody = $("logTableBody");
const lineBadge = $("lineBadge");

function clone(obj){ return JSON.parse(JSON.stringify(obj)); }

function loadJSON(key, fallback){
  try{
    const raw = localStorage.getItem(key);
    if(!raw) return clone(fallback);
    const parsed = JSON.parse(raw);
    if(parsed === null || typeof parsed !== "object") return clone(fallback);
    return parsed;
  }catch{
    return clone(fallback);
  }
}
function saveJSON(key, val){
  localStorage.setItem(key, JSON.stringify(val));
}

function setStatus(kind, title, detail){
  statusBox.classList.remove("good","bad","warn");
  if(kind) statusBox.classList.add(kind);
  statusText.textContent = title;
  statusDetail.textContent = detail;
}

function fmtNum(n){
  if(n === null || n === undefined || Number.isNaN(n)) return "—";
  return String(n);
}
function fmtPct(p){
  if(p === null || p === undefined || Number.isNaN(p)) return "—";
  return (p*100).toFixed(1) + "%";
}
function nowHHMM(){
  const d = new Date();
  return String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0");
}
function nowDateStr(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function parseHourToDate(hourStr, baseDate){
  const [hh, mm] = hourStr.split(":").map(Number);
  const d = new Date(baseDate);
  d.setHours(hh, mm, 0, 0);
  return d;
}

function rebuildLineOptions(){
  const lines = Object.keys(targets).sort((a,b)=>a.localeCompare(b));
  lineSelect.innerHTML = "";
  for(const line of lines){
    const opt = document.createElement("option");
    opt.value = line;
    opt.textContent = line;
    lineSelect.appendChild(opt);
  }
  if(lines.length === 0){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "No lines loaded";
    lineSelect.appendChild(opt);
  }
}
function rebuildHourOptions(){
  const line = lineSelect.value;
  const lineTargets = targets[line] || {};
  const hours = Object.keys(lineTargets).sort((a,b)=>a.localeCompare(b));
  hourSelect.innerHTML = "";
  for(const hr of hours){
    const opt = document.createElement("option");
    opt.value = hr;
    opt.textContent = hr;
    hourSelect.appendChild(opt);
  }
  if(hours.length === 0){
    const opt = document.createElement("option");
    opt.value = "06:00";
    opt.textContent = "06:00";
    hourSelect.appendChild(opt);
  }
}
function updateTargetsJsonBox(){ targetsJson.value = JSON.stringify(targets, null, 2); }
function updateTargetsTable(){
  const line = lineSelect.value;
  lineBadge.textContent = line || "—";
  targetsTableBody.innerHTML = "";
  const lineTargets = targets[line] || {};
  const hours = Object.keys(lineTargets).sort((a,b)=>a.localeCompare(b));
  for(const hr of hours){
    const tr = document.createElement("tr");
    const tdH = document.createElement("td");
    const tdT = document.createElement("td");
    tdH.textContent = hr;
    tdT.textContent = lineTargets[hr];
    tr.appendChild(tdH);
    tr.appendChild(tdT);
    targetsTableBody.appendChild(tr);
  }
}
function refreshTargetPill(){
  const line = lineSelect.value;
  const hr = hourSelect.value;
  const base = Number(targets?.[line]?.[hr]);
  if(Number.isFinite(base)){
    const pct = Number(targetMode.value)/100;
    const modeTarget = Math.round(base * pct);
    targetInline.textContent = `${modeTarget}`;
  }else{
    targetInline.textContent = "—";
  }
}

function isCurrentHour(hr){
  const now = new Date();
  const start = parseHourToDate(hr, now);
  const end = new Date(start);
  end.setMinutes(start.getMinutes()+60);
  return (now >= start && now < end);
}

function calcProjection(actual, hr){
  if(!isCurrentHour(hr)) return { minsRemain:null, reqPerMin:null, projEnd:null, projDelta:null };

  const now = new Date();
  const start = parseHourToDate(hr, now);
  const end = new Date(start); end.setMinutes(start.getMinutes()+60);

  const minsElapsed = Math.max(0, Math.floor((now - start)/60000));
  const minsRemain  = Math.max(0, Math.ceil((end - now)/60000));

  // pace so far: units per minute (avoid divide by 0)
  const pace = (minsElapsed > 0) ? (actual / minsElapsed) : null;
  const projEnd = (pace !== null) ? Math.round(actual + pace * minsRemain) : null;

  return { minsRemain, pace, projEnd };
}

function calculate(){
  const line = lineSelect.value;
  const hr = hourSelect.value;
  const actual = Number(actualInput.value);

  const base = Number(targets?.[line]?.[hr]);
  const modePct = Number(targetMode.value) / 100;
  const modeTarget = Number.isFinite(base) ? Math.round(base * modePct) : NaN;

  refreshTargetPill();

  if(!line || !hr || !Number.isFinite(base)){
    setStatus("warn","Targets missing","Load targets for this line/hour (import CSV or paste JSON), then retry.");
    targetOut.textContent="—"; deltaOut.textContent="—"; hprOut.textContent="—"; neededOut.textContent="—";
    minsRemainOut.textContent="—"; rateOut.textContent="—"; projOut.textContent="—"; projDeltaOut.textContent="—";
    lastCalcSnapshot = null;
    return;
  }

  if(!Number.isFinite(actual) || actual < 0){
    setStatus("warn","Enter actual units","Type the units completed so far this hour, then press Calculate.");
    targetOut.textContent=fmtNum(modeTarget); deltaOut.textContent="—"; hprOut.textContent="—"; neededOut.textContent="—";
    minsRemainOut.textContent="—"; rateOut.textContent="—"; projOut.textContent="—"; projDeltaOut.textContent="—";
    lastCalcSnapshot = null;
    return;
  }

  const delta = actual - modeTarget;
  const hpr = (base === 0) ? null : (actual / base);
  const needed = Math.max(0, modeTarget - actual);

  targetOut.textContent = fmtNum(modeTarget);
  deltaOut.textContent  = (delta >= 0 ? `+${delta}` : `${delta}`);
  hprOut.textContent    = fmtPct(hpr);
  neededOut.textContent = fmtNum(needed);

  if(delta >= 0){
    setStatus("good","ON TRACK",`You are +${delta} units vs MODE target for ${line} @ ${hr}.`);
  }else{
    setStatus("bad","OFF TRACK",`You are short ${Math.abs(delta)} units vs MODE target for ${line} @ ${hr}.`);
  }

  // pace / projection
  const proj = calcProjection(actual, hr);
  if(proj.minsRemain !== null){
    minsRemainOut.textContent = String(proj.minsRemain);
    if(proj.minsRemain > 0){
      const reqPerMin = needed / proj.minsRemain;
      rateOut.textContent = reqPerMin.toFixed(2);
    }else{
      rateOut.textContent = (needed === 0) ? "0.00" : "—";
    }

    projOut.textContent = (proj.projEnd === null ? "—" : String(proj.projEnd));
    const projDelta = (proj.projEnd === null) ? null : (proj.projEnd - modeTarget);
    projDeltaOut.textContent = (projDelta === null ? "—" : (projDelta >= 0 ? `+${projDelta}` : `${projDelta}`));
  }else{
    minsRemainOut.textContent="—"; rateOut.textContent="—"; projOut.textContent="—"; projDeltaOut.textContent="—";
  }

  lastCalcSnapshot = {
    date: nowDateStr(),
    time: nowHHMM(),
    line, hour: hr,
    actual,
    targetBase: base,
    targetModePct: Number(targetMode.value),
    targetModeTarget: modeTarget,
    delta
  };
}

function getBestHourFromOptions(){
  const now = new Date();
  const options = [...hourSelect.options].map(o=>o.value);
  if(options.length === 0) return null;

  let best = options[0];
  let bestD = parseHourToDate(best, now);

  for(const opt of options){
    const d = parseHourToDate(opt, now);
    if(d <= now && d >= bestD){ best = opt; bestD = d; }
  }
  return best;
}

function parseCSV(text){
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  if(lines.length < 2) throw new Error("CSV must include header + at least one row.");
  const header = lines[0].split(",").map(s=>s.trim().toLowerCase());
  const idxLine = header.indexOf("line");
  const idxHour = header.indexOf("hour");
  const idxTarget = header.indexOf("target");
  if(idxLine < 0 || idxHour < 0 || idxTarget < 0){
    throw new Error("CSV header must be: line,hour,target");
  }
  const out = {};
  for(let i=1;i<lines.length;i++){
    const cols = lines[i].split(",").map(s=>s.trim());
    if(cols.length < 3) continue;
    const line = cols[idxLine];
    const hour = cols[idxHour];
    const target = Number(cols[idxTarget]);
    if(!line || !hour || !Number.isFinite(target)) continue;
    out[line] = out[line] || {};
    out[line][hour] = target;
  }
  return out;
}
function mergeTargets(newOnes){
  for(const [line, obj] of Object.entries(newOnes)){
    targets[line] = targets[line] || {};
    for(const [hr, val] of Object.entries(obj)){ targets[line][hr] = val; }
  }
}

function renderLog(){
  logTableBody.innerHTML = "";
  // show latest 60 rows
  const rows = [...hourLog].slice(-60).reverse();
  for(const r of rows){
    const tr = document.createElement("tr");
    const cells = [
      r.date, r.time, r.line, r.hour,
      r.actual, r.targetModeTarget, r.targetModePct + "%", r.delta
    ];
    for(const c of cells){
      const td = document.createElement("td");
      td.textContent = String(c);
      tr.appendChild(td);
    }
    logTableBody.appendChild(tr);
  }
}

function downloadBlob(filename, content, mime){
  const blob = new Blob([content], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function exportLogCSV(){
  const header = ["date","time","line","hour","actual","target_base","target_mode_pct","target_mode_target","delta"];
  const lines = [header.join(",")];
  for(const r of hourLog){
    lines.push([
      r.date, r.time, r.line, r.hour,
      r.actual, r.targetBase, r.targetModePct, r.targetModeTarget, r.delta
    ].join(","));
  }
  downloadBlob(`hpr_hour_log_${nowDateStr()}.csv`, lines.join("\n"), "text/csv");
}
function exportLogJSON(){
  downloadBlob(`hpr_hour_log_${nowDateStr()}.json`, JSON.stringify(hourLog, null, 2), "application/json");
}

/* Events */
$("calcBtn").addEventListener("click", calculate);
actualInput.addEventListener("keydown", (e)=>{ if(e.key === "Enter") calculate(); });

$("useNowBtn").addEventListener("click", ()=>{
  const best = getBestHourFromOptions();
  if(best){
    hourSelect.value = best;
    refreshTargetPill();
    calculate();
  }
});

$("clearBtn").addEventListener("click", ()=>{
  actualInput.value = "";
  refreshTargetPill();
  setStatus(null,"Waiting for input","Select line + hour, enter actual units, then Calculate.");
  targetOut.textContent="—"; deltaOut.textContent="—"; hprOut.textContent="—"; neededOut.textContent="—";
  minsRemainOut.textContent="—"; rateOut.textContent="—"; projOut.textContent="—"; projDeltaOut.textContent="—";
  lastCalcSnapshot = null;
});

$("addLogBtn").addEventListener("click", ()=>{
  if(!lastCalcSnapshot){
    setStatus("warn","Nothing to log","Run Calculate first, then Add to Log.");
    return;
  }
  hourLog.push(lastCalcSnapshot);
  saveJSON(LS_KEY_LOG, hourLog);
  renderLog();
  setStatus("good","Logged","Hour added to log. Export CSV/JSON anytime.");
});

lineSelect.addEventListener("change", ()=>{
  rebuildHourOptions();
  updateTargetsTable();
  refreshTargetPill();
});
hourSelect.addEventListener("change", refreshTargetPill);
targetMode.addEventListener("change", ()=>{
  refreshTargetPill();
  // if we already have an actual value, recalc
  if(actualInput.value !== "") calculate();
});

$("saveTargetsBtn").addEventListener("click", ()=>{
  try{
    const parsed = JSON.parse(targetsJson.value);
    if(!parsed || typeof parsed !== "object") throw new Error("Invalid JSON structure.");
    targets = parsed;
    saveJSON(LS_KEY_TARGETS, targets);
    rebuildLineOptions();
    rebuildHourOptions();
    updateTargetsJsonBox();
    updateTargetsTable();
    refreshTargetPill();
    setStatus("good","Targets saved","Targets updated and stored locally.");
  }catch(err){
    setStatus("warn","Could not save targets", String(err.message || err));
  }
});

$("resetTargetsBtn").addEventListener("click", ()=>{
  targets = clone(SAMPLE_TARGETS);
  saveJSON(LS_KEY_TARGETS, targets);
  rebuildLineOptions();
  rebuildHourOptions();
  updateTargetsJsonBox();
  updateTargetsTable();
  refreshTargetPill();
  setStatus("warn","Reset to sample","Import your real targets from your HPR tracker when ready.");
});

$("importCsvBtn").addEventListener("click", async ()=>{
  const f = $("csvFile").files?.[0];
  if(!f){
    setStatus("warn","No CSV selected","Choose a CSV file first, then click Import CSV.");
    return;
  }
  try{
    const text = await f.text();
    const parsed = parseCSV(text);
    mergeTargets(parsed);
    saveJSON(LS_KEY_TARGETS, targets);
    rebuildLineOptions();
    rebuildHourOptions();
    updateTargetsJsonBox();
    updateTargetsTable();
    refreshTargetPill();
    setStatus("good","CSV imported","Targets merged successfully.");
  }catch(err){
    setStatus("warn","CSV import failed", String(err.message || err));
  }
});

$("exportLogCsvBtn").addEventListener("click", exportLogCSV);
$("exportLogJsonBtn").addEventListener("click", exportLogJSON);
$("clearLogBtn").addEventListener("click", ()=>{
  hourLog = [];
  saveJSON(LS_KEY_LOG, hourLog);
  renderLog();
  setStatus("warn","Log cleared","Hour log cleared on this device.");
});

/* Clock */
function startClock(){
  stopClock();
  const tick = ()=>{ nowClock.textContent = nowHHMM(); };
  tick();
  clockTimer = setInterval(tick, 1000);
}
function stopClock(){
  if(clockTimer) clearInterval(clockTimer);
  clockTimer = null;
}
toggleClockBtn.addEventListener("click", ()=>{
  clockOn = !clockOn;
  toggleClockBtn.textContent = `Clock: ${clockOn ? "ON" : "OFF"}`;
  if(clockOn) startClock(); else stopClock();
});

/* Init */
rebuildLineOptions();
rebuildHourOptions();
updateTargetsJsonBox();
updateTargetsTable();
renderLog();
startClock();
refreshTargetPill();
setStatus(null,"Waiting for input","Select line + hour, enter actual units, then Calculate.");
</script>
</body>
</html>
